<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Medication Scheduler</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:"Poppins",sans-serif;background:#f0f4f8;margin:0;padding:0;}
header{background:#0077b6;color:white;text-align:center;padding:1rem;border-radius:0 0 20px 20px;}
.container{margin-top:20px;max-width:980px;}
.card{border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:20px;padding:15px;}
.progress{height:20px;border-radius:10px;}
footer{text-align:center;margin-top:30px;color:#333;}
.motivation{background:#e0f7fa;padding:10px;margin-top:10px;border-radius:10px;text-align:center;font-weight:600;color:#00796b;}
#confetti {position:fixed;inset:0;pointer-events:none;z-index:1000;display:none}
.confetti-piece{position:absolute;width:10px;height:14px;border-radius:2px;opacity:0.95;transform:translateY(-10vh);}
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); opacity:0 } }
.doctor-pin{background:#fff3cd;color:#856404;padding:10px;margin-bottom:10px;border-radius:10px;font-weight:600;border:1px solid #ffeeba;}
</style>
</head>
<body>
<header>
<h1>üíä SmartMed:Multimedia-Driven Medication Reminder & Health Visualization System</h1>
<p> Smart Reminders</p>
</header>
<div class="container">

<!-- Pinned Doctor Reminder -->
<div id="doctorPinContainer"></div>

<!-- Reminder List -->
<div class="card" id="reminderCard" style="display:none;">
<h4>üìå Upcoming Reminders</h4>
<ul id="reminderList" class="list-group"></ul>
</div>

<!-- Add Medicine Manually -->
<div class="card">
<h4>‚ûï Add Medicine</h4>
<div class="mb-2">
<label>Medicine Name</label>
<input id="medName" class="form-control" placeholder="e.g. Paracetamol 500mg">
</div>
<div class="mb-2">
<label>Dosage</label>
<input id="medDose" class="form-control" placeholder="e.g. 1 tablet after meal">
</div>
<div class="mb-2">
<label>Time</label>
<input type="time" id="medTime" class="form-control">
</div>
<div class="mb-2">
<label>Schedule Type</label>
<select id="medFreq" class="form-select">
<option value="daily">Daily</option>
<option value="alternate">Alternate Days</option>
<option value="custom">Custom Date</option>
</select>
</div>
<div id="dailyBox" class="mb-2">
<label>Start Date</label>
<input type="date" id="dailyStart" class="form-control">
<label>End Date</label>
<input type="date" id="dailyEnd" class="form-control">
</div>
<div id="alternateBox" class="mb-2" style="display:none;">
<label>Start Date</label>
<input type="date" id="altStart" class="form-control">
<label>End Date (optional)</label>
<input type="date" id="altEnd" class="form-control">
</div>
<div id="customBox" class="mb-2" style="display:none;">
<label>Pick Date</label>
<input type="date" id="customDate" class="form-control">
</div>
<div class="mb-2">
<label>Doctor Email</label>
<input id="doctorEmail" type="email" class="form-control" placeholder="doctor@example.com">
<label>Next Visit Date</label>
<input type="date" id="visitDate" class="form-control">
</div>
<button class="btn btn-success w-100" id="addMed">Add to Schedule</button>
</div>

<!-- Medicine List -->
<div class="card">
<h4>üóì Today's & Tomorrow's Schedule</h4>
<div id="medicineList"></div>
</div>

<!-- Health Report -->
<div class="card" id="chartCard" style="display:none;">
<h4>üìà Health Report</h4>
<canvas id="progressChart" height="150"></canvas>
<div id="medicineGraphDiv"></div>
<h5>üíö Health Improvement</h5>
<canvas id="healthBar" height="100"></canvas>
<div id="daysLeftDiv" class="motivation"></div>
<button class="btn btn-secondary mt-2" id="exportPDF">Download PDF</button>
</div>

<div id="confetti"></div>
</div>
<footer>Made with ‚ù§ using AI & Multimedia Systems</footer>

<script>
let medList = JSON.parse(localStorage.getItem("medList")||"[]");
let reminderTimers = [];
const healthQuotes = [
  "Health is wealth ‚Äì take care of it!",
  "A healthy body leads to a healthy mind.",
  "Every dose you take brings you closer to wellness.",
  "Your health is your superpower!",
  "Small steps every day lead to big health gains."
];

// Show random quote on load
function showRandomQuote(){
  const q = healthQuotes[Math.floor(Math.random()*healthQuotes.length)];
  const div = document.createElement("div");
  div.className="motivation";
  div.textContent = q;
  document.querySelector(".container").prepend(div);
}
showRandomQuote();

// Utility Functions
function speak(msg){window.speechSynthesis.speak(new SpeechSynthesisUtterance(msg));}
function showConfetti(){
  const confetti=document.getElementById("confetti");
  confetti.style.display="block";
  for(let i=0;i<100;i++){
    let c=document.createElement("div");
    c.className="confetti-piece";
    c.style.left=Math.random()*100+"vw";
    c.style.background=["#ff0","#f00","#0f0","#0ff","#f0f","#fa0"][Math.floor(Math.random()*6)];
    confetti.appendChild(c);
    c.style.animation="fall "+(Math.random()*3+2)+"s linear forwards"
  }
  setTimeout(()=>{confetti.innerHTML="";confetti.style.display="none"},3000);
}

// Schedule Type Toggle
document.getElementById("medFreq").onchange=function(){
let v=this.value;
document.getElementById("dailyBox").style.display=v==="daily"?"block":"none";
document.getElementById("alternateBox").style.display=v==="alternate"?"block":"none";
document.getElementById("customBox").style.display=v==="custom"?"block":"none";
};

// Add Medicine
document.getElementById("addMed").addEventListener("click",()=>{
let name=document.getElementById("medName").value.trim();
let dose=document.getElementById("medDose").value.trim();
let time=document.getElementById("medTime").value;
let freq=document.getElementById("medFreq").value;
let start="", end="", customDate="", doctorEmail="", visitDate="";
if(!name || !dose || !time){ alert("Please fill all required fields"); return; }
if(freq==="daily"){ start=document.getElementById("dailyStart").value; end=document.getElementById("dailyEnd").value; if(!start || !end){ alert("Pick start and end date"); return; } }
else if(freq==="alternate"){ start=document.getElementById("altStart").value; end=document.getElementById("altEnd").value; if(!start){ alert("Pick start date"); return; } }
else{ customDate=document.getElementById("customDate").value; if(!customDate){ alert("Pick custom date"); return; } }
doctorEmail=document.getElementById("doctorEmail").value.trim();
visitDate=document.getElementById("visitDate").value;

let med={name,dose,time,freq,start,end,customDate,status:"",doctorEmail,visitDate,totalTaken:0};
medList.push(med);
localStorage.setItem("medList",JSON.stringify(medList));

// Show pinned doctor reminder at top
updateDoctorPin();

renderList();
setupReminders();
resetInputs();
});

// Reset Input Fields
function resetInputs(){
document.getElementById("medName").value="";
document.getElementById("medDose").value="";
document.getElementById("medTime").value="";
document.getElementById("dailyStart").value="";
document.getElementById("dailyEnd").value="";
document.getElementById("altStart").value="";
document.getElementById("altEnd").value="";
document.getElementById("customDate").value="";
document.getElementById("doctorEmail").value="";
document.getElementById("visitDate").value="";
}

// Update Doctor Pin Reminder
function updateDoctorPin(){
const container = document.getElementById("doctorPinContainer");
container.innerHTML="";
medList.forEach(m=>{
if(m.doctorEmail && m.visitDate){
const now = new Date();
const medTime = new Date(m.visitDate+"T00:00:00");
if(!m.status){ // Only show if not taken/missed
let div = document.createElement("div");
div.className="doctor-pin";
div.textContent = `üìå Send your report to ${m.doctorEmail} before ${m.visitDate}`;
container.appendChild(div);
}
}
});
}

// Helper: Check if a medicine is scheduled today or tomorrow
function isTodayOrTomorrow(med){
let today = new Date(); today.setHours(0,0,0,0);
let tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
let medDates = [];
if(med.freq==="daily"){ let s = new Date(med.start); let e = new Date(med.end); for(let d=s;d<=e;d.setDate(d.getDate()+1)){medDates.push(new Date(d));} }
else if(med.freq==="alternate"){ let s = new Date(med.start); let e = med.end?new Date(med.end):s; let add=true; for(let d=s;d<=e;d.setDate(d.getDate()+1)){ if(add){medDates.push(new Date(d));} add=!add;} }
else if(med.freq==="custom"){ medDates.push(new Date(med.customDate)); }
return medDates.some(d=>d.toDateString()===today.toDateString() || d.toDateString()===tomorrow.toDateString());
}

// Render Medicine List
function renderList(){
const listDiv=document.getElementById("medicineList"); listDiv.innerHTML="";
medList.forEach((med,i)=>{
if(!isTodayOrTomorrow(med)) return;
let div=document.createElement("div"); div.className="border p-2 mb-2 rounded d-flex justify-content-between align-items-center";

let now = new Date();
let medTime = med.time.split(":");
let medDate = med.freq==="daily"?new Date(med.start+"T"+med.time):
              med.freq==="alternate"?new Date(med.start+"T"+med.time):
              new Date(med.customDate+"T"+med.time);
let disabled = (now < medDate || med.status) ? "disabled" : "";

let daysLeft = calculateTotalDoses(med) - (med.status==="taken"?1:0);

div.innerHTML=`<div><strong>${med.name}</strong> - ${med.dose} at ${med.time}<br>
Schedule: ${med.freq.charAt(0).toUpperCase()+med.freq.slice(1)}<br>
Status: <select data-index="${i}" class="statusSelect form-select form-select-sm w-auto d-inline" ${disabled}>
<option value="">--Select--</option>
<option value="taken" ${med.status==="taken"?"selected":""}>Taken</option>
<option value="missed" ${med.status==="missed"?"selected":""}>Missed</option>
</select><br>Days left: ${daysLeft}</div>
<button class="btn btn-danger btn-sm" data-index="${i}" ${med.status?"disabled":""}>Delete</button>`;
listDiv.appendChild(div);

// Status change
div.querySelector(".statusSelect").onchange=function(){
let idx=parseInt(this.dataset.index); let val=this.value;
if(val!=="taken" && val!=="missed"){ alert("Please select either Taken or Missed"); this.value=""; return; }
medList[idx].status=val; localStorage.setItem("medList",JSON.stringify(medList));
if(val==="taken"){showConfetti();updateGraphs(); cancelReminder(idx);}
renderList(); updateDoctorPin();
};
div.querySelector("button").onclick=function(){let idx=parseInt(this.dataset.index);medList.splice(idx,1);renderList(); setupReminders();}
});
updateGraphs();
}

// Total doses calculator
function calculateTotalDoses(med){
if(med.freq==="daily" && med.start && med.end){
let s=new Date(med.start); let e=new Date(med.end);
return Math.floor((e-s)/(1000*60*60*24))+1;
}else if(med.freq==="alternate" && med.start){
let s=new Date(med.start); let e=med.end?new Date(med.end):s;
let days = Math.floor((e-s)/(1000*60*60*24))+1;
return Math.ceil(days/2);
}else{return 1;}
}

// Update Donut + Bar + Medicine Graphs
let chartInstance=null, healthBarInstance=null;
function updateGraphs(){
if(!medList.length){document.getElementById("chartCard").style.display="none";return;}
document.getElementById("chartCard").style.display="block";

// Donut chart
let taken=medList.filter(m=>m.status==="taken").length;
let missed=medList.filter(m=>m.status==="missed").length;
let pending=medList.length-taken-missed;
let ctx=document.getElementById("progressChart").getContext("2d");
if(chartInstance) chartInstance.destroy();
chartInstance=new Chart(ctx,{type:"doughnut",
data:{labels:["Taken","Missed","Pending"],datasets:[{data:[taken,missed,pending],backgroundColor:["#28a745","#dc3545","#ffc107"]}]},
options:{responsive:true,plugins:{legend:{position:"bottom"}}}});

// Per medicine progress + days left
let div=document.getElementById("medicineGraphDiv"); div.innerHTML="";
medList.forEach((med,i)=>{
let totalDoses=calculateTotalDoses(med);
let remaining=totalDoses - (med.status==="taken"?1:0);
div.innerHTML+=`<p><strong>${med.name} (${med.freq.charAt(0).toUpperCase()+med.freq.slice(1)}):</strong> ${remaining} dose(s) left</p>`;
});

// Positivity Bar Chart (Health Improvement)
let labels=medList.map(m=>m.name);
let data = medList.map(m=>m.status==="taken"?calculateTotalDoses(m):0);
let ctx2=document.getElementById("healthBar").getContext("2d");
if(healthBarInstance) healthBarInstance.destroy();
healthBarInstance=new Chart(ctx2,{type:"bar",data:{labels, datasets:[{label:"Health Improvement", data, backgroundColor:"#28a745"}]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
}

// Setup Reminders
function setupReminders(){
reminderTimers.forEach(t=>clearTimeout(t)); reminderTimers=[];
let now=new Date();
let reminderList=document.getElementById("reminderList"); reminderList.innerHTML="";
medList.forEach((med,i)=>{
if(med.status==="taken") return;

// Schedule Medicine Reminder (Voice + Popup)
scheduleMedicineReminder(med,i);

// Doctor report reminder
if(med.doctorEmail && med.visitDate){
let visit=new Date(med.visitDate + "T00:00:00");
let reminderDay = new Date(visit.getTime() - 24*60*60*1000); // 1 day before
let diff = reminderDay-now;
if(diff>0){
let li=document.createElement("li"); li.className="list-group-item";
li.textContent=`Send your report to ${med.doctorEmail} before ${med.visitDate}`;
reminderList.appendChild(li);
let timer=setTimeout(()=>{ 
alert(`Dear user! Send report to ${med.doctorEmail} for visit on ${med.visitDate}`);
speak(`Dear user! Send report to ${med.doctorEmail} for visit on ${med.visitDate}`);
}, diff);
reminderTimers.push(timer);
}
}
});
document.getElementById("reminderCard").style.display=reminderList.children.length>0?"block":"none";
}

// Medicine Reminder Scheduler
function scheduleMedicineReminder(med, idx){
let now = new Date();
let medTime = med.time.split(":");
let medDate = med.freq==="daily"?new Date(med.start+"T"+med.time):
              med.freq==="alternate"?new Date(med.start+"T"+med.time):
              new Date(med.customDate+"T"+med.time);
let diff = medDate-now;
if(diff>0){
let timer=setTimeout(()=>{
speak(`Dear user, it's time to take your ${med.name} ${med.dose}`);
alert(`Time to take ${med.name} ${med.dose}`);
renderList();
}, diff);
reminderTimers.push(timer);
}
}

// Cancel reminder for taken medicine
function cancelReminder(idx){reminderTimers.forEach(t=>clearTimeout(t)); setupReminders();}

// PDF Export
document.getElementById("exportPDF").onclick=function(){
const { jsPDF } = window.jspdf;
let doc=new jsPDF();
doc.text("Today's Medication Report",10,10);
medList.forEach((m,i)=>{doc.text(`${i+1}. ${m.name} - ${m.dose} at ${m.time} [${m.status||'pending'}]`,10,20+10*i);});
doc.save("medication_report.pdf");
}

// Initialize
renderList(); setupReminders();
updateDoctorPin();
</script>
</body>
</html>
